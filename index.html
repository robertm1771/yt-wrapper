<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3-Panel YouTube + URL Loader</title>
    <style>
        :root {
            --side-width: 35%;
            --top-height: 60%;
            --gutter-size: 10px;
            --handle-color: #2a2a2a;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        #controls {
            padding: 10px;
            background: #111;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            box-sizing: border-box;
            align-items: center;
        }

        #controls input {
            width: 280px;
            padding: 5px;
            background: #000;
            border: 1px solid #444;
            color: #fff;
            font-size: 12px;
        }

        #controls > div {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #controls button {
            padding: 6px 12px;
            border: 1px solid #444;
            background: #222;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
        }

        #controls button:hover {
            background: #333;
        }

        .version {
            margin-left: auto;
            font-size: 12px;
            color: #0ff;
            background: #002b36;
            border: 1px solid #044a63;
            border-radius: 12px;
            padding: 4px 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .version::before {
            content: "●";
            color: #4cf3ff;
            font-size: 10px;
        }

        #status {
            font-size: 12px;
            color: #8f8;
            min-height: 16px;
        }

        #layout {
            height: calc(100% - 60px);
            display: grid;
            position: relative;
            grid-template-columns: calc(100% - var(--side-width)) var(--side-width);
            grid-template-rows: var(--top-height) calc(100% - var(--top-height));
            grid-template-areas:
                "youtube side"
                "bottom bottom";
            gap: var(--gutter-size);
            padding: 8px;
            box-sizing: border-box;
        }

        .youtube-pane {
            grid-area: youtube;
        }

        .side-pane {
            grid-area: side;
        }

        .bottom-pane {
            grid-area: bottom;
            width: 100%;
            aspect-ratio: 16 / 9;
            height: auto;
            max-height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }

        .resize-handle {
            position: absolute;
            background: var(--handle-color);
            z-index: 5;
            opacity: 0.7;
            transition: background 0.2s ease, opacity 0.2s ease;
        }

        .resize-handle:hover,
        .resize-handle:active {
            background: #3a3a3a;
            opacity: 1;
        }

        .resize-handle.vertical {
            top: 8px;
            bottom: 8px;
            width: var(--gutter-size);
            left: calc(100% - var(--side-width));
            cursor: col-resize;
        }

        .resize-handle.horizontal {
            left: 8px;
            right: 8px;
            height: var(--gutter-size);
            top: var(--top-height);
            cursor: row-resize;
        }
    </style>
</head>
<body>

    <div id="controls">
        <div>
            <input id="ytInput" type="text" placeholder="Paste YouTube link here (watch, live, or youtu.be)">
            <button onclick="loadYouTube()">Load YouTube</button>
            <button onclick="refreshYouTube()">Refresh YouTube</button>
        </div>

        <div>
            <input id="url1" type="text" placeholder="Right-side URL">
            <input id="url2" type="text" placeholder="Bottom URL">
            <button onclick="loadOther()">Load Right Frames</button>
            <button onclick="refreshRightFrames()">Refresh Right Frames</button>
        </div>

        <div id="status" aria-live="polite"></div>

        <div class="version" aria-label="Application version" id="appVersion">v0.3.0</div>
    </div>

    <div id="layout">
        <!-- NOTE: referrerpolicy added here -->
        <iframe
            class="youtube-pane"
            id="ytFrame"
            allowfullscreen
            referrerpolicy="strict-origin-when-cross-origin">
        </iframe>

        <iframe class="side-pane" id="frame1"></iframe>
        <iframe class="bottom-pane" id="frame2"></iframe>

        <div class="resize-handle vertical" id="verticalHandle" title="Drag to resize side panel"></div>
        <div class="resize-handle horizontal" id="horizontalHandle" title="Drag to resize bottom panel"></div>
    </div>

<script>
function convertToEmbedded(url) {
    if (!url) return "";

    url = url.trim();

    // Already embed
    if (url.includes("youtube.com/embed/") || url.includes("youtube-nocookie.com/embed/")) {
        return url;
    }

    try {
        const u = new URL(url);

        // Standard watch URL
        if (u.hostname.includes("youtube.com") && u.pathname === "/watch") {
            const id = u.searchParams.get("v");
            if (id) return "https://www.youtube-nocookie.com/embed/" + id;
        }

        // youtu.be short link
        if (u.hostname === "youtu.be") {
            const id = u.pathname.replace("/", "");
            if (id) return "https://www.youtube-nocookie.com/embed/" + id;
        }

        // Live URL
        if (u.hostname.includes("youtube.com") && u.pathname.startsWith("/live/")) {
            const id = u.pathname.split("/")[2];
            if (id) return "https://www.youtube-nocookie.com/embed/" + id;
        }
    } catch (e) {
        console.error("Invalid URL:", e);
    }

    // Fallback
    return url;
}

function setFrameSrc(frameId, url) {
    const frame = document.getElementById(frameId);
    const target = url || "about:blank";
    const current = frame.getAttribute("src") || "";

    // Force reload even if the same URL is entered again.
    if (current === target) {
        frame.src = "about:blank";
        requestAnimationFrame(() => frame.src = target);
    } else {
        frame.src = target;
    }
}

const APP_VERSION = "v0.3.0";
const RIGHT_PANELS_KEY = "yt-wrapper:right-panels";
const LAYOUT_KEY = "yt-wrapper:layout";
const DEFAULT_LAYOUT = {
    sideWidth: 35,
    topHeight: 60,
};
let layoutState = { ...DEFAULT_LAYOUT };

function renderVersion() {
    const versionEl = document.getElementById("appVersion");
    if (versionEl) {
        versionEl.textContent = `Version ${APP_VERSION}`;
        versionEl.setAttribute("data-version", APP_VERSION);
    }

    document.title = `3-Panel YouTube + URL Loader (${APP_VERSION})`;
}

function persistRightPanels(url1, url2) {
    const payload = { url1, url2 };
    try {
        localStorage.setItem(RIGHT_PANELS_KEY, JSON.stringify(payload));
    } catch (e) {
        console.warn("Unable to persist right panel URLs", e);
    }
}

function restoreRightPanels() {
    try {
        const raw = localStorage.getItem(RIGHT_PANELS_KEY);
        if (!raw) return;

        const { url1 = "", url2 = "" } = JSON.parse(raw);

        document.getElementById("url1").value = url1;
        document.getElementById("url2").value = url2;

        if (url1) setFrameSrc("frame1", url1);
        if (url2) setFrameSrc("frame2", url2);

        if (url1 || url2) {
            showStatus("Restored right-side frames.");
        }
    } catch (e) {
        console.warn("Unable to restore right panel URLs", e);
    }
}

function clamp(value, min, max) {
    return Math.min(max, Math.max(min, value));
}

function applyLayout({ sideWidth = layoutState.sideWidth, topHeight = layoutState.topHeight } = {}) {
    const newSideWidth = clamp(sideWidth, 15, 85);
    const newTopHeight = clamp(topHeight, 25, 85);

    layoutState = {
        sideWidth: newSideWidth,
        topHeight: newTopHeight,
    };

    document.documentElement.style.setProperty("--side-width", `${newSideWidth}%`);
    document.documentElement.style.setProperty("--top-height", `${newTopHeight}%`);
}

function persistLayout() {
    try {
        localStorage.setItem(LAYOUT_KEY, JSON.stringify(layoutState));
    } catch (e) {
        console.warn("Unable to persist layout", e);
    }
}

function restoreLayoutSizing() {
    try {
        const raw = localStorage.getItem(LAYOUT_KEY);
        if (!raw) {
            applyLayout(DEFAULT_LAYOUT);
            return;
        }

        const saved = JSON.parse(raw);
        applyLayout({
            sideWidth: saved.sideWidth ?? DEFAULT_LAYOUT.sideWidth,
            topHeight: saved.topHeight ?? DEFAULT_LAYOUT.topHeight,
        });
    } catch (e) {
        console.warn("Unable to restore layout", e);
        applyLayout(DEFAULT_LAYOUT);
    }
}

function startResize(type, event) {
    event.preventDefault();
    const layout = document.getElementById("layout");

    function onMove(e) {
        const rect = layout.getBoundingClientRect();

        if (type === "vertical") {
            const offset = clamp(e.clientX - rect.left, 80, rect.width - 80);
            const sideWidth = 100 - ((offset / rect.width) * 100);
            applyLayout({ sideWidth });
        } else if (type === "horizontal") {
            const offset = clamp(e.clientY - rect.top, 80, rect.height - 80);
            const topHeight = (offset / rect.height) * 100;
            applyLayout({ topHeight });
        }
    }

    function onUp() {
        persistLayout();
        document.removeEventListener("pointermove", onMove);
        document.removeEventListener("pointerup", onUp);
    }

    document.addEventListener("pointermove", onMove);
    document.addEventListener("pointerup", onUp);
}

function loadYouTube() {
    const raw = document.getElementById("ytInput").value;
    const embed = convertToEmbedded(raw);

    if (!embed) {
        return showStatus("Please enter a YouTube link first.", true);
    }

    setFrameSrc("ytFrame", embed);
    showStatus("YouTube video loaded.");
}

function loadOther() {
    const url1 = document.getElementById("url1").value.trim();
    const url2 = document.getElementById("url2").value.trim();

    setFrameSrc("frame1", url1);
    setFrameSrc("frame2", url2);

    persistRightPanels(url1, url2);

    if (!url1 && !url2) {
        showStatus("Right-side frames cleared.");
    } else {
        showStatus("Right-side frames loaded.");
    }
}

function refreshYouTube() {
    const ytFrame = document.getElementById("ytFrame");
    const current = ytFrame.getAttribute("src");
    const input = document.getElementById("ytInput").value.trim();

    if (current) {
        setFrameSrc("ytFrame", current);
        showStatus("YouTube frame refreshed.");
        return;
    }

    const embed = convertToEmbedded(input);
    if (embed) {
        setFrameSrc("ytFrame", embed);
        showStatus("YouTube frame loaded and refreshed.");
    } else {
        showStatus("Nothing to refresh for YouTube.", true);
    }
}

function refreshRightFrames() {
    const url1 = document.getElementById("frame1").getAttribute("src") || document.getElementById("url1").value.trim();
    const url2 = document.getElementById("frame2").getAttribute("src") || document.getElementById("url2").value.trim();

    if (!url1 && !url2) {
        showStatus("Nothing to refresh on right side.", true);
        return;
    }

    if (url1) setFrameSrc("frame1", url1);
    if (url2) setFrameSrc("frame2", url2);

    showStatus("Right-side frames refreshed.");
}

// Enter key auto-load for YouTube
document.getElementById("ytInput").addEventListener("keydown", function(e){
    if (e.key === "Enter") loadYouTube();
});

// Enter key auto-load for the right-side URLs
document.getElementById("url1").addEventListener("keydown", function(e){
    if (e.key === "Enter") loadOther();
});

document.getElementById("url2").addEventListener("keydown", function(e){
    if (e.key === "Enter") loadOther();
});

document.getElementById("verticalHandle").addEventListener("pointerdown", function(e){
    startResize("vertical", e);
});

document.getElementById("horizontalHandle").addEventListener("pointerdown", function(e){
    startResize("horizontal", e);
});

function showStatus(message, isError = false) {
    const el = document.getElementById("status");
    el.textContent = message;
    el.style.color = isError ? "#f55" : "#8f8";
}

renderVersion();
restoreLayoutSizing();
restoreRightPanels();
showStatus(`Ready · ${APP_VERSION}`);
</script>

</body>
</html>
